# .github/workflows/miro-deploy.yml
name: Miro - Test & Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, gd, iconv, json, mbstring, pdo, session, simplexml, tokenizer, xml, ctype, fileinfo, openssl, pdo_mysql
        coverage: none
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Composer dependencies
      run: composer install --prefer-dist --no-progress
    
    - name: Install NPM dependencies
      run: npm ci
    
    - name: Copy environment file
      run: cp .env.example .env
    
    - name: Generate application key
      run: php artisan key:generate
    
    - name: Run PHP tests
      run: php artisan test
    
    - name: Run NPM tests
      run: npm test
    
    - name: Build assets
      run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to TimeWeb.Cloud server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.TIMEWEB_HOST }}
        username: ${{ secrets.TIMEWEB_USERNAME }}
        key: ${{ secrets.TIMEWEB_SSH_KEY }}
        script: |
          echo "ğŸš€ Starting Miro deployment..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ĞµÑĞ»Ğ¸ Ğ¸Ñ… Ğ½ĞµÑ‚
          sudo mkdir -p /var/www/miro
          sudo mkdir -p /var/www/backups
          sudo mkdir -p /var/log/miro
          sudo chown -R www-data:www-data /var/www/miro
          sudo chown -R www-data:www-data /var/www/backups
          sudo chown -R www-data:www-data /var/log/miro
          
          # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾
          if pm2 list | grep -q "miro"; then
            echo "â¹ï¸ Stopping Miro application..."
            pm2 stop miro
          fi
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±ÑĞºĞ°Ğ¿ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
          if [ -d "/var/www/miro/app" ]; then
            echo "ğŸ’¾ Creating backup..."
            cd /var/www/backups
            sudo tar -czf "miro_backup_$(date +%Y%m%d_%H%M%S).tar.gz" -C /var/www/miro .
          fi
          
          # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
          cd /var/www/miro
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ PHP Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
          echo "ğŸ“¦ Installing PHP dependencies..."
          composer install --no-dev --optimize-autoloader
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Node.js Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
          echo "ğŸ“¦ Installing Node.js dependencies..."
          npm ci --only=production
          
          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ assets
          echo "ğŸ”¨ Building assets..."
          npm run build
          
          # ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Laravel
          echo "âš™ï¸ Configuring Laravel..."
          cp .env.example .env
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          # ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)
          if [ -f "artisan" ]; then
            echo "ğŸ—„ï¸ Running migrations..."
            php artisan migrate --force
          fi
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ°
          echo "ğŸ” Setting permissions..."
          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
          echo "â–¶ï¸ Starting application..."
          pm2 start ecosystem-laravel.config.js --env production
          pm2 save
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
          echo "ğŸ“Š Application status:"
          pm2 status miro
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ
          echo "ğŸ” Checking availability..."
          sleep 10
          if curl -f http://localhost:8000 > /dev/null 2>&1; then
            echo "âœ… Application is running successfully!"
          else
            echo "âŒ Application failed to start!"
            exit 1
          fi
          
          echo "ğŸ‰ Miro deployment completed successfully!"
