# .github/workflows/moodboard-deploy.yml
name: Moodboard - Test, Build & Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test
    
    - name: Build project
      run: npm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: moodboard-dist
        path: dist/

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: moodboard-dist
        path: dist/
    
    - name: Deploy to TimeWeb.Cloud server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.TIMEWEB_HOST }}
        username: ${{ secrets.TIMEWEB_USERNAME }}
        key: ${{ secrets.TIMEWEB_SSH_KEY }}
        script: |
          echo "üöÄ Starting Moodboard deployment..."
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          sudo mkdir -p /var/www/moodboard
          sudo chown -R www-data:www-data /var/www/moodboard
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º moodboard –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω
          if pm2 list | grep -q "moodboard"; then
            pm2 stop moodboard
          fi
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é moodboard
          cd /var/www/moodboard
          
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git fetch origin
          git reset --hard origin/main
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          echo "üì¶ Copying built files..."
          sudo rm -rf dist/
          sudo cp -r /tmp/dist/ .
          sudo chown -R www-data:www-data dist/
          
          # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
          if [ -d "dist" ]; then
            echo "üíæ Creating backup..."
            sudo mkdir -p /var/www/backups
            sudo tar -czf "/var/www/backups/moodboard_backup_$(date +%Y%m%d_%H%M%S).tar.gz" dist/
          fi
          
          echo "‚úÖ Moodboard deployment completed!"
          
          # –£–≤–µ–¥–æ–º–ª—è–µ–º miro –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          echo "üîÑ Moodboard updated, consider updating miro project"
